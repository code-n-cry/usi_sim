<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>–ú–µ–Ω–µ–¥–∂–µ—Ä –ú–µ—Ç–æ–∫</title>

    <!-- –°—Ç–æ—Ä–æ–Ω–Ω—è—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ Pico.css -->
    <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">

    <!-- –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ -->
    <link rel="stylesheet" href="{{ url_for('static', path='styles.css') }}">
</head>
<body>
<main class="container">
    <h1>–ú–µ–Ω–µ–¥–∂–µ—Ä –ú–µ—Ç–æ–∫</h1>
    <div class="buttons">
        <button id="back-button">–ù–∞–∑–∞–¥ –∫ –º–µ—Ç–∫–∞–º</button>
        <button id="add-label" class="contrast">–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–∫—É</button>
        <button id="add-patology">–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ç–æ–ª–æ–≥–∏—é</button>
        <button id="rename-label">–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –º–µ—Ç–∫—É</button>
        <button id="change-code">–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–¥ –º–µ—Ç–∫–∏</button>
        <button id="delete-label">–£–¥–∞–ª–∏—Ç—å –º–µ—Ç–∫—É</button>
        <button id="toggle-theme" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">‚òÄÔ∏è</button>
    </div>
    <div id="file-manager" class="main-view"></div>
</main>

<script>
    // Theme toggle
    const THEME_KEY = 'theme';
    const toggleBtn = document.getElementById('toggle-theme');
    let theme = localStorage.getItem(THEME_KEY) || 'light';
    const applyTheme = () => {
        document.documentElement.setAttribute('data-theme', theme);
        toggleBtn.textContent = theme === 'light' ? '‚òÄÔ∏è' : 'üåô';
    };
    applyTheme();
    toggleBtn.addEventListener('click', () => {
        theme = (theme === 'light' ? 'dark' : 'light');
        localStorage.setItem(THEME_KEY, theme);
        applyTheme();
    });

    // API as before...
    const api = {
        getAll:    () => fetch('/api/data').then(r => r.json()),
        createLbl:(num,code)=> fetch('/api/labels',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({number:num,code}) }),
        renameNum:(lbl,newNum)=> fetch(`/api/labels/${encodeURIComponent(lbl)}/number`,{ method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({newName:newNum}) }),
        renameCode:(lbl,newCode)=> fetch(`/api/labels/${encodeURIComponent(lbl)}/code`,{ method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({newName:newCode}) }),
        delLbl: lbl=> fetch(`/api/labels/${encodeURIComponent(lbl)}`,{method:'DELETE'}),
        createPat:(lbl,name)=> fetch(`/api/labels/${encodeURIComponent(lbl)}/pathologies`,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name}) }),
        renamePat:(lbl,pat,newName)=> fetch(`/api/labels/${encodeURIComponent(lbl)}/pathologies/${encodeURIComponent(pat)}`,{ method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({newName}) }),
        delPat:(lbl,pat)=> fetch(`/api/labels/${encodeURIComponent(lbl)}/pathologies/${encodeURIComponent(pat)}`,{method:'DELETE'}),
        upload:(lbl,pat,files)=>{
            const fd = new FormData();
            files.forEach(f=>fd.append('files', f));
            return fetch(`/api/labels/${encodeURIComponent(lbl)}/pathologies/${encodeURIComponent(pat)}/files`,{ method:'POST', body:fd });
        }
    };

    let data = [], currentLabel = null;
    let openStates = JSON.parse(localStorage.getItem('openStates')||'{}');
    const fm        = document.getElementById('file-manager');
    const backBtn   = document.getElementById('back-button');
    const addLblBtn = document.getElementById('add-label');
    const addPatBtn = document.getElementById('add-patology');
    const renLblBtn = document.getElementById('rename-label');
    const chCodeBtn = document.getElementById('change-code');
    const delLblBtn = document.getElementById('delete-label');
    const header    = document.querySelector('h1');

    function saveOpenStates(){ localStorage.setItem('openStates', JSON.stringify(openStates)); }

    backBtn.onclick = ()=>{ currentLabel = null; loadAndRender(); };
    addLblBtn.onclick = async ()=>{ const num=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ç–∫–∏:'), code=prompt('–ö–æ–¥ –º–µ—Ç–∫–∏:'); if(!num||!code) return; await api.createLbl(num,code); loadAndRender(); };
    renLblBtn.onclick = async ()=>{ const [n,c]=currentLabel.split('_'); const nn=prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:',n); if(!nn) return; await api.renameNum(currentLabel,nn); currentLabel=`${nn}_${c}`; loadAndRender(); };
    chCodeBtn.onclick = async ()=>{ const [n,c]=currentLabel.split('_'); const nc=prompt('–ù–æ–≤—ã–π –∫–æ–¥:',c); if(!nc) return; await api.renameCode(currentLabel,nc); currentLabel=`${n}_${nc}`; loadAndRender(); };
    delLblBtn.onclick = async ()=>{ if(!confirm(`–£–¥–∞–ª–∏—Ç—å –º–µ—Ç–∫—É ¬´${currentLabel}¬ª?`)) return; await api.delLbl(currentLabel); currentLabel=null; loadAndRender(); };
    addPatBtn.onclick = async ()=>{ const nm=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞—Ç–æ–ª–æ–≥–∏–∏:'); if(!nm) return; await api.createPat(currentLabel,nm); loadAndRender(); };

    async function loadAndRender(){
        data = await api.getAll();
        render();
    }

    function render(){
        // —Ç–µ–º–∞ –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ
        toggleBtn.style.display = currentLabel ? 'none' : 'inline-block';
        header.textContent = currentLabel || '–ú–µ–Ω–µ–¥–∂–µ—Ä –ú–µ—Ç–æ–∫';

        if(!currentLabel){
            backBtn.style.display='none';
            addLblBtn.style.display='inline-block';
            addPatBtn.style.display=renLblBtn.style.display=chCodeBtn.style.display=delLblBtn.style.display='none';
            fm.classList.add('main-view');
        } else {
            backBtn.style.display='inline-block';
            addLblBtn.style.display='none';
            addPatBtn.style.display=renLblBtn.style.display=chCodeBtn.style.display=delLblBtn.style.display='inline-block';
            fm.classList.remove('main-view');
        }

        fm.innerHTML='';
        if(!currentLabel){
            data.forEach(lbl=>{
                const d=document.createElement('details'); d.open=true;
                const s=document.createElement('summary'); s.textContent=lbl.name;
                const act=document.createElement('span'); act.className='actions';
                act.appendChild(createBtn('–í–æ–π—Ç–∏',()=>{ currentLabel=lbl.name; render(); }));
                s.appendChild(act); d.appendChild(s); fm.appendChild(d);
            });
        } else {
            const lbl=data.find(l=>l.name===currentLabel);
            lbl.pathologies.forEach(pat=>{
                const key=currentLabel+'|'+pat.name;
                const d=document.createElement('details');
                d.open=!!openStates[key];
                d.addEventListener('toggle',()=>{ openStates[key]=d.open; saveOpenStates(); });

                const s=document.createElement('summary'); s.textContent=pat.name;
                const act=document.createElement('span'); act.className='actions';
                act.append(
                    createBtn('–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ',()=>{
                        openStates[key]=true; saveOpenStates();
                        const inp=document.createElement('input'); inp.type='file'; inp.multiple=true; inp.accept='video/*';
                        inp.onchange=async()=>{ await api.upload(currentLabel,pat.name,Array.from(inp.files)); loadAndRender(); };
                        inp.click();
                    }),
                    createBtn('–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å',async()=>{
                        const nm=prompt('–ù–æ–≤–æ–µ –∏–º—è –ø–∞—Ç–æ–ª–æ–≥–∏–∏:',pat.name);
                        if(!nm) return;
                        await api.renamePat(currentLabel,pat.name,nm);
                        delete openStates[key];
                        loadAndRender();
                    }),
                    createBtn('–£–¥–∞–ª–∏—Ç—å',async()=>{
                        if(!confirm(`–£–¥–∞–ª–∏—Ç—å –ø–∞—Ç–æ–ª–æ–≥–∏—é ¬´${pat.name}¬ª?`))return;
                        await api.delPat(currentLabel,pat.name);
                        delete openStates[key];
                        loadAndRender();
                    })
                );
                s.appendChild(act); d.appendChild(s);

                const ul=document.createElement('ul'); ul.className='video-list';
                pat.files.forEach(url=>{
                    const li=document.createElement('li');
                    const a=document.createElement('a'); a.href=url; a.textContent=url.split('/').pop(); a.target='_blank';
                    li.appendChild(a); ul.appendChild(li);
                });
                d.appendChild(ul); fm.appendChild(d);
            });
        }
    }

    function createBtn(text,fn){
        const b=document.createElement('button');
        b.type='button'; b.textContent=text;
        b.addEventListener('click',e=>{ e.stopPropagation(); fn(); });
        return b;
    }

    loadAndRender();
</script>
</body>
</html>
